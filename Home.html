<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Animal Disease Risk Checker</title>
    <!-- Load Tailwind CSS for modern styling and responsiveness -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for appearance */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            min-height: 100vh;
        }
        .container-card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .input-box {
            transition: all 0.2s;
        }
        .btn-check {
            transition: background-color 0.3s, transform 0.1s;
        }
        .btn-check:active {
            transform: scale(0.98);
        }
        /* Style for the select arrow */
        select {
          -webkit-appearance: none;
          -moz-appearance: none;
          appearance: none;
          background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%234B5563" d="M7 10l5 5 5-5z"/></svg>');
          background-repeat: no-repeat;
          background-position: right 10px center;
          padding-right: 30px;
        }
        /* Loading Spinner Animation */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-start justify-center p-4">

    <!-- Main Application Card -->
    <div id="app" class="container-card w-full max-w-xl bg-white p-6 md:p-10 mt-8 rounded-xl">
        <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-2">Dynamic Pet Health Risk Finder</h1>
        <p class="text-center text-sm text-gray-500 mb-8">
            Enter any city and animal. Data is dynamically sourced from public veterinary and health reports.
        </p>

        <!-- Input Form -->
        <div class="space-y-4">
            <div>
                <label for="locationInput" class="block text-sm font-medium text-gray-700 mb-1">City/Area Name:</label>
                <input type="text" id="locationInput" placeholder="e.g., London, UK or Bengaluru, IN" class="input-box w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="Tambaram">
            </div>

            <div>
                <label for="animalInput" class="block text-sm font-medium text-gray-700 mb-1">Animal:</label>
                <div class="relative">
                    <select id="animalInput" class="input-box w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
                        <option value="cat">Cat</option>
                        <option value="dog">Dog</option>
                        <option value="rabbit">Rabbit</option>
                        <option value="horse">Horse</option>
                    </select>
                </div>
            </div>

            <button id="checkButton" onclick="getDiseaseRisk()" class="btn-check w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg shadow-lg flex items-center justify-center">
                Check Disease Risk
            </button>
        </div>

        <!-- Results Area -->
        <div id="results" class="mt-8 pt-4 border-t border-gray-200">
            <!-- Results will appear here -->
            <p class="text-center text-gray-500 italic">Enter your details and click 'Check Risk' to generate a report.</p>
        </div>
    </div>

    <script>
        // --- 1. Gemini API Configuration ---
        // IMPORTANT: When deploying this code to a public web server (outside of this environment), 
        // you must replace the empty string below with your actual Gemini API Key for it to work.
        const apiKey = ""; // API key is automatically provided in this environment
        const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';

        // --- 2. Core Functions ---

        /**
         * Generic fetch utility with exponential backoff for resilience.
         * Retries up to 3 times on failure.
         */
        async function fetchWithExponentialBackoff(url, options, maxRetries = 3) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // Throw an error to be caught and potentially retried
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        console.error('API call failed after all retries:', error);
                        throw new Error('Could not connect to the disease database. Please try again later.');
                    }
                    // Wait with exponential backoff before the next attempt
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Fetches disease data using Gemini API with Google Search grounding.
         */
        async function fetchDiseaseDataFromGemini(animal, location) {
            const systemPrompt = `You are a specialized Veterinary Public Health Analyst. Your task is to provide a detailed, factual summary of the top 3-5 high-risk and most prevalent diseases (viral, bacterial, parasitic) affecting ${animal} in the specific region of ${location}. Base your findings ONLY on current public health reports, government veterinary databases, and major, reputable local veterinary news sources found via search. 
                                  For each disease, create a separate, concise paragraph that clearly states the Disease Name, Risk Level (High, Medium, Low), and a brief, specific local prevalence note. Use clear, easy-to-read language suitable for a pet owner. Do NOT use markdown headings, bullet points, or tables, but ensure each disease is in its own clearly separated paragraph.`;
            
            const userQuery = `Summarize the major current animal disease risks for ${animal} in ${location}.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const urlWithKey = `${apiUrl}?key=${apiKey}`;

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            const response = await fetchWithExponentialBackoff(urlWithKey, options);
            return response.json();
        }

        /**
         * Main function to handle user interaction and data fetching.
         */
        async function getDiseaseRisk() {
            const locationInput = document.getElementById('locationInput').value.trim();
            const animalInput = document.getElementById('animalInput').value.trim();
            const resultsDiv = document.getElementById('results');
            const checkButton = document.getElementById('checkButton');
            
            resultsDiv.innerHTML = '';
            
            if (!locationInput || !animalInput) {
                displayMessage(resultsDiv, "Please enter a valid city/area and select an animal.", 'bg-red-100 text-red-700 border-red-300');
                return;
            }

            // 1. Show Loading State
            checkButton.disabled = true;
            checkButton.innerHTML = '<span class="spinner"></span> Generating Report...';
            resultsDiv.innerHTML = ''; 

            try {
                // 2. Fetch Data
                const result = await fetchDiseaseDataFromGemini(animalInput, locationInput);
                const candidate = result.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                     throw new Error("The risk checker could not generate a valid report.");
                }

                const text = candidate.content.parts[0].text;
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;

                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title); // Ensure sources are valid
                }

                // 3. Display Results
                let resultsHTML = `<h2 class="text-xl font-bold text-gray-700 mb-4">Disease Risk Report for ${animalInput} in ${locationInput}:</h2>`;
                
                // Display Generated Text
                // The newlines are crucial for separating the paragraphs/diseases as instructed in the system prompt.
                resultsHTML += `<div class="p-6 bg-white border border-gray-200 rounded-xl shadow-inner mb-6 text-gray-700">
                                    <p>${text.replace(/\n/g, '<br><br>')}</p>
                                </div>`;

                // Display Sources
                if (sources.length > 0) {
                    resultsHTML += `<h3 class="text-md font-semibold text-gray-600 mb-2">Sources:</h3>`;
                    resultsHTML += `<ul class="list-disc list-inside text-sm text-gray-500 space-y-1 p-2 bg-gray-50 rounded-lg">`;
                    sources.slice(0, 5).forEach((source, index) => { // Limit to top 5 sources
                        resultsHTML += `<li><a href="${source.uri}" target="_blank" class="text-blue-600 hover:text-blue-800 break-words">${source.title}</a></li>`;
                    });
                    resultsHTML += `</ul>`;
                } else {
                    resultsHTML += `<p class="text-sm text-gray-400 italic mt-4">No specific web sources were cited for this report.</p>`;
                }
                
                resultsDiv.innerHTML = resultsHTML;

            } catch (error) {
                console.error("Error in getDiseaseRisk:", error);
                const errorMessage = error.message.includes('Could not connect') 
                    ? error.message 
                    : "An unexpected error occurred while fetching data. Please refine your search and try again.";
                displayMessage(resultsDiv, `🚨 Error: ${errorMessage}`, 'bg-red-100 text-red-700 border-red-300');
            } finally {
                // 4. Restore Button State
                checkButton.disabled = false;
                checkButton.innerHTML = 'Check Disease Risk';
            }
        }

        /**
         * Helper function to display messages to the user.
         */
        function displayMessage(element, message, classString) {
            element.innerHTML = `<p class="p-4 text-center rounded-lg border ${classString}">${message}</p>`;
        }
    </script>
</body>
</html>
